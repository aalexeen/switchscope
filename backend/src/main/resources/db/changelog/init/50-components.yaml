databaseChangeLog:
  - changeSet:
      id: create-components-table
      author: AALEXEEN
      changes:
        - createTable:
            tableName: components
            columns:
              # ============================================================
              # BaseEntity fields
              # ============================================================
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false

              # ============================================================
              # NamedEntity fields
              # ============================================================
              - column:
                  name: name
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT

              # ============================================================
              # Discriminator column for Single Table Inheritance
              # ============================================================
              - column:
                  name: component_class
                  type: VARCHAR(64)
                  constraints:
                    nullable: false

              # ============================================================
              # Component specific fields - Identification
              # ============================================================
              - column:
                  name: manufacturer
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: model
                  type: VARCHAR(128)
                  constraints:
                    nullable: true
              - column:
                  name: serial_number
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
              - column:
                  name: part_number
                  type: VARCHAR(128)
                  constraints:
                    nullable: true

              # ============================================================
              # Component specific fields - Foreign Keys
              # ============================================================
              - column:
                  name: component_status_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: component_type_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: component_nature_id
                  type: UUID
                  constraints:
                    nullable: true
              - column:
                  name: installation_id
                  type: UUID
                  constraints:
                    nullable: true
              - column:
                  name: parent_component_id
                  type: UUID
                  constraints:
                    nullable: true

              # ============================================================
              # Component specific fields - Maintenance
              # ============================================================
              - column:
                  name: last_maintenance_date
                  type: TIMESTAMP
                  constraints:
                    nullable: true
              - column:
                  name: next_maintenance_date
                  type: TIMESTAMP
                  constraints:
                    nullable: true

        # ============================================================
        # Unique constraints
        # ============================================================
        - addUniqueConstraint:
            tableName: components
            columnNames: manufacturer, serial_number
            constraintName: uk_manufacturer_serial

        # ============================================================
        # Foreign keys
        # ============================================================
        - addForeignKeyConstraint:
            baseTableName: components
            baseColumnNames: component_status_id
            constraintName: fk_component_status
            referencedTableName: component_statuses_catalog
            referencedColumnNames: id
            onDelete: RESTRICT

        - addForeignKeyConstraint:
            baseTableName: components
            baseColumnNames: component_type_id
            constraintName: fk_component_type
            referencedTableName: component_types_catalog
            referencedColumnNames: id
            onDelete: RESTRICT

        - addForeignKeyConstraint:
            baseTableName: components
            baseColumnNames: component_nature_id
            constraintName: fk_component_nature
            referencedTableName: component_natures_catalog
            referencedColumnNames: id
            onDelete: RESTRICT

        - addForeignKeyConstraint:
            baseTableName: components
            baseColumnNames: installation_id
            constraintName: fk_component_installation
            referencedTableName: installations
            referencedColumnNames: id
            onDelete: SET NULL

        - addForeignKeyConstraint:
            baseTableName: components
            baseColumnNames: parent_component_id
            constraintName: fk_component_parent
            referencedTableName: components
            referencedColumnNames: id
            onDelete: SET NULL

        # ============================================================
        # Indexes
        # ============================================================
        - createIndex:
            tableName: components
            indexName: idx_component_class
            columns:
              - column:
                  name: component_class

        - createIndex:
            tableName: components
            indexName: idx_component_serial_number
            columns:
              - column:
                  name: serial_number

        - createIndex:
            tableName: components
            indexName: idx_component_status_id
            columns:
              - column:
                  name: component_status_id

        - createIndex:
            tableName: components
            indexName: idx_component_type_id
            columns:
              - column:
                  name: component_type_id

        - createIndex:
            tableName: components
            indexName: idx_component_nature_id
            columns:
              - column:
                  name: component_nature_id

        - createIndex:
            tableName: components
            indexName: idx_component_installation_id
            columns:
              - column:
                  name: installation_id

        - createIndex:
            tableName: components
            indexName: idx_component_parent_id
            columns:
              - column:
                  name: parent_component_id

        - createIndex:
            tableName: components
            indexName: idx_component_status_type
            columns:
              - column:
                  name: component_status_id
              - column:
                  name: component_type_id

        - createIndex:
            tableName: components
            indexName: idx_component_next_maintenance
            columns:
              - column:
                  name: next_maintenance_date

        - createIndex:
            tableName: components
            indexName: idx_component_manufacturer_model
            columns:
              - column:
                  name: manufacturer
              - column:
                  name: model


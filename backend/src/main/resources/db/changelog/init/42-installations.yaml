databaseChangeLog:
  - changeSet:
      id: create-installations-table
      author: AALEXEEN
      changes:
        - createTable:
            tableName: installations
            columns:
              # ============================================================
              # BaseEntity fields
              # ============================================================
              - column:
                  name: id
                  type: UUID
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMP
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false

              # ============================================================
              # Installation specific fields - References
              # ============================================================

              # Location where the component is installed
              - column:
                  name: location_id
                  type: UUID
                  constraints:
                    nullable: false

              # Housing component (component that contains/houses the installed item)
              # Note: FK to components will be added after components table is created
              - column:
                  name: housing_component_id
                  type: UUID
                  constraints:
                    nullable: true

              # What type of item is being installed
              - column:
                  name: installable_type_id
                  type: UUID
                  constraints:
                    nullable: false

              # ID of the actual installed item (Component.id, Device.id, etc.)
              - column:
                  name: installed_item_id
                  type: INTEGER
                  constraints:
                    nullable: false

              # Current status of the installation
              - column:
                  name: status_id
                  type: UUID
                  constraints:
                    nullable: false

              # ============================================================
              # Installation specific fields - Physical positioning
              # ============================================================
              - column:
                  name: rack_position
                  type: INTEGER
                  constraints:
                    nullable: true
              - column:
                  name: rack_unit_height
                  type: INTEGER
                  constraints:
                    nullable: true
              - column:
                  name: position_description
                  type: VARCHAR(256)
                  constraints:
                    nullable: true

              # ============================================================
              # Installation specific fields - Timestamps
              # ============================================================
              - column:
                  name: installed_at
                  type: TIMESTAMP
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: removed_at
                  type: TIMESTAMP
                  constraints:
                    nullable: true
              - column:
                  name: last_status_change
                  type: TIMESTAMP
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false

              # ============================================================
              # Installation specific fields - User tracking
              # ============================================================
              - column:
                  name: installed_by
                  type: VARCHAR(128)
                  constraints:
                    nullable: true
              - column:
                  name: removed_by
                  type: VARCHAR(128)
                  constraints:
                    nullable: true
              - column:
                  name: status_changed_by
                  type: VARCHAR(128)
                  constraints:
                    nullable: true

              # ============================================================
              # Installation specific fields - Additional metadata
              # ============================================================
              - column:
                  name: installation_notes
                  type: TEXT
                  constraints:
                    nullable: true
              - column:
                  name: cable_management
                  type: VARCHAR(256)
                  constraints:
                    nullable: true

        # Foreign key for location_id
        - addForeignKeyConstraint:
            baseTableName: installations
            baseColumnNames: location_id
            constraintName: fk_installation_location
            referencedTableName: locations
            referencedColumnNames: id
            onDelete: RESTRICT

        # Foreign key for installable_type_id
        - addForeignKeyConstraint:
            baseTableName: installations
            baseColumnNames: installable_type_id
            constraintName: fk_installation_installable_type
            referencedTableName: installable_types_catalog
            referencedColumnNames: id
            onDelete: RESTRICT

        # Foreign key for status_id
        - addForeignKeyConstraint:
            baseTableName: installations
            baseColumnNames: status_id
            constraintName: fk_installation_status
            referencedTableName: installation_statuses_catalog
            referencedColumnNames: id
            onDelete: RESTRICT

        # Indexes
        - createIndex:
            tableName: installations
            indexName: idx_installation_location
            columns:
              - column:
                  name: location_id

        - createIndex:
            tableName: installations
            indexName: idx_installation_housing_component
            columns:
              - column:
                  name: housing_component_id

        - createIndex:
            tableName: installations
            indexName: idx_installation_type
            columns:
              - column:
                  name: installable_type_id

        - createIndex:
            tableName: installations
            indexName: idx_installation_status
            columns:
              - column:
                  name: status_id

        - createIndex:
            tableName: installations
            indexName: idx_installation_installed_item
            columns:
              - column:
                  name: installable_type_id
              - column:
                  name: installed_item_id

        - createIndex:
            tableName: installations
            indexName: idx_installation_rack_position
            columns:
              - column:
                  name: location_id
              - column:
                  name: rack_position

  # Note: FK for housing_component_id -> components.id is added in 90-installation-component-fk.yaml
  # (after components table is created in 50-components.yaml)
